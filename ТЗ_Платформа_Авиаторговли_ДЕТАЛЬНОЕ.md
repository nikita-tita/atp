# –î–ï–¢–ê–õ–¨–ù–û–ï –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï
## –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ –∞–≤–∏–∞—Ç–µ—Ö–Ω–∏–∫–æ–π

> **–í–ï–†–°–ò–Ø:** 2.0  
> **–î–ê–¢–ê:** 2024-01-16  
> **–°–¢–ê–¢–£–°:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ  
> **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:** –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ Docker

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#1-–æ–±—â–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã](#2-–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã) 
3. [Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#3-docker-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
4. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#4-–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
5. [API —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏](#5-api-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)
6. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#6-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
7. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#7-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
8. [Deployment](#8-deployment)

---

## 1. –û–ë–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### 1.1 –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```mermaid
graph TB
    subgraph "Client Layer"
        Web[Web App React]
        Mobile[Mobile PWA]
        Admin[Admin Panel]
    end
    
    subgraph "API Gateway"
        Gateway[NGINX/Traefik]
    end
    
    subgraph "Core Services"
        Auth[Auth Service]
        Verification[Verification Service]
        Marketplace[Marketplace Service]
        Analytics[Analytics Service]
        Notification[Notification Service]
        Payment[Payment Service]
        FileStorage[File Storage Service]
    end
    
    subgraph "Infrastructure"
        Database[(PostgreSQL)]
        Cache[(Redis)]
        Search[(Elasticsearch)]
        Queue[RabbitMQ]
        Storage[MinIO S3]
        AnalyticsDB[(ClickHouse)]
    end
    
    subgraph "External Services"
        FAA[FAA API]
        EASA[EASA API]
        Banking[Banking APIs]
        Email[Email Service]
        SMS[SMS Gateway]
    end
    
    Client --> Gateway
    Gateway --> Core
    Core --> Infrastructure
    Core --> External
```

### 1.2 –ü—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã**: –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
- **API-First**: –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ REST/GraphQL API
- **Event-Driven**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ message queue
- **Docker-Native**: –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω—ã
- **Stateless**: –°–µ—Ä–≤–∏—Å—ã –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- **Circuit Breaker**: –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—Ç–∫–∞–∑–æ–≤
- **Database per Service**: –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç —Å–≤–æ—é –ë–î

---

## 2. –ú–ò–ö–†–û–°–ï–†–í–ò–°–´

### 2.1 Auth Service (–°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)

#### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞–º–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ (RBAC)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ (OAuth2)

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Runtime**: Node.js + TypeScript
- **Framework**: Express.js + Passport.js
- **Database**: PostgreSQL (users, roles, permissions)
- **Cache**: Redis (sessions, refresh tokens)
- **Docker base**: node:18-alpine

#### API Endpoints:
```typescript
// Registration
POST /api/auth/register
Body: { email, password, companyName, userType }
Response: { user, accessToken, refreshToken }

// Login  
POST /api/auth/login
Body: { email, password }
Response: { user, accessToken, refreshToken }

// Token refresh
POST /api/auth/refresh
Body: { refreshToken }
Response: { accessToken }

// Logout
POST /api/auth/logout
Headers: { Authorization: Bearer <token> }

// User profile
GET /api/auth/profile
Headers: { Authorization: Bearer <token> }
Response: { user, roles, permissions }
```

#### Database Schema:
```sql
-- Users table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    company_name VARCHAR(255),
    phone VARCHAR(20),
    status VARCHAR(20) DEFAULT 'pending', -- pending, verified, suspended
    user_type VARCHAR(20) NOT NULL, -- buyer, seller, broker, admin
    verification_level INTEGER DEFAULT 0, -- 0-3
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP
);

-- Roles and permissions
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT
);

CREATE TABLE permissions (
    id SERIAL PRIMARY KEY, 
    name VARCHAR(100) UNIQUE NOT NULL,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL
);

CREATE TABLE user_roles (
    user_id UUID REFERENCES users(id),
    role_id INTEGER REFERENCES roles(id),
    PRIMARY KEY (user_id, role_id)
);
```

#### Docker Configuration:
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3001
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s \
  CMD curl -f http://localhost:3001/health || exit 1
USER node
CMD ["node", "dist/index.js"]
```

### 2.2 Verification Service (–°–µ—Ä–≤–∏—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)

#### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–π –∏ —á–∞—Å—Ç–Ω—ã—Ö –ª–∏—Ü
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–π –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- Workflow —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Runtime**: Go 1.21
- **Framework**: Gin + GORM
- **Database**: PostgreSQL (verification data)
- **Cache**: Redis (verification results)
- **Message Queue**: RabbitMQ (async verification)
- **Docker base**: golang:1.21-alpine

#### API Endpoints:
```go
// Start verification process
POST /api/verification/start
Body: { userId, verificationType, documents[] }
Response: { verificationId, status, estimatedTime }

// Check verification status
GET /api/verification/{verificationId}/status
Response: { status, progress, results, issues }

// Upload documents
POST /api/verification/{verificationId}/documents
Body: multipart/form-data
Response: { documentId, status }

// Manual review
POST /api/verification/{verificationId}/review
Body: { decision, comments, reviewerId }
Response: { status, updatedAt }
```

#### Workflow States:
```mermaid
stateDiagram-v2
    [*] --> Submitted
    Submitted --> DocumentsRequired
    DocumentsRequired --> AutoCheck
    AutoCheck --> Approved: All checks pass
    AutoCheck --> ManualReview: Some checks fail
    AutoCheck --> Rejected: Critical checks fail
    ManualReview --> Approved
    ManualReview --> Rejected
    ManualReview --> DocumentsRequired
    Approved --> [*]
    Rejected --> [*]
```

#### External Integrations:
```go
// FAA Aircraft Registry
type FAAClient struct {
    baseURL string
    apiKey  string
}

func (c *FAAClient) VerifyTailNumber(tailNumber string) (*AircraftInfo, error)
func (c *FAAClient) VerifyOwnership(tailNumber, ownerName string) (bool, error)

// OFAC Sanctions Check
type OFACClient struct {
    baseURL string
}

func (c *OFACClient) CheckSanctions(entity *Entity) (*SanctionsResult, error)

// Banking verification 
type BankingClient struct {
    plaidClient *plaid.Client
}

func (c *BankingClient) VerifyBankAccount(accountInfo *BankAccount) (*VerificationResult, error)
```

### 2.3 Marketplace Service (–¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞)

#### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ —Å–∞–º–æ–ª–µ—Ç–æ–≤
- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- –°–∏—Å—Ç–µ–º–∞ "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤"
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Runtime**: Node.js + TypeScript
- **Framework**: NestJS + TypeORM
- **Database**: PostgreSQL (listings, aircraft data)
- **Search**: Elasticsearch (advanced search)
- **File Storage**: MinIO (images, documents)
- **Docker base**: node:18-alpine

#### Database Schema:
```sql
-- Aircraft listings
CREATE TABLE aircraft_listings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    seller_id UUID REFERENCES users(id),
    aircraft_model VARCHAR(100) NOT NULL,
    manufacturer VARCHAR(100) NOT NULL,
    year_manufactured INTEGER,
    tail_number VARCHAR(20) UNIQUE,
    hours_total INTEGER,
    price DECIMAL(12,2),
    currency VARCHAR(3) DEFAULT 'USD',
    location_country VARCHAR(2),
    location_city VARCHAR(100),
    description TEXT,
    status VARCHAR(20) DEFAULT 'active', -- active, sold, suspended
    featured BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Aircraft specifications
CREATE TABLE aircraft_specifications (
    listing_id UUID REFERENCES aircraft_listings(id),
    engine_type VARCHAR(50),
    engine_hours INTEGER,
    avionics TEXT[],
    interior_configuration VARCHAR(100),
    exterior_color VARCHAR(50),
    max_passengers INTEGER,
    max_range_nm INTEGER,
    max_speed_kts INTEGER,
    useful_load_lbs INTEGER
);

-- Aircraft images
CREATE TABLE aircraft_images (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    listing_id UUID REFERENCES aircraft_listings(id),
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255),
    mime_type VARCHAR(100),
    size_bytes INTEGER,
    image_order INTEGER DEFAULT 0,
    is_primary BOOLEAN DEFAULT FALSE,
    uploaded_at TIMESTAMP DEFAULT NOW()
);

-- Customer reservations (—É–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
CREATE TABLE customer_reservations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    buyer_id UUID REFERENCES users(id),
    broker_id UUID REFERENCES users(id),
    listing_id UUID REFERENCES aircraft_listings(id),
    reserved_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,
    status VARCHAR(20) DEFAULT 'active', -- active, expired, released
    UNIQUE(buyer_id, listing_id)
);
```

#### Search Implementation (Elasticsearch):
```typescript
// Elasticsearch mapping
const aircraftMapping = {
  properties: {
    id: { type: 'keyword' },
    manufacturer: { 
      type: 'text',
      analyzer: 'standard',
      fields: { keyword: { type: 'keyword' } }
    },
    model: { 
      type: 'text',
      analyzer: 'standard', 
      fields: { keyword: { type: 'keyword' } }
    },
    year: { type: 'integer' },
    price: { type: 'long' },
    location: { type: 'geo_point' },
    hours_total: { type: 'integer' },
    max_passengers: { type: 'integer' },
    created_at: { type: 'date' }
  }
}

// Search service
class AircraftSearchService {
  async searchAircraft(query: SearchQuery): Promise<SearchResult> {
    const body = {
      query: {
        bool: {
          must: this.buildMustClauses(query),
          filter: this.buildFilterClauses(query)
        }
      },
      sort: this.buildSortClauses(query.sort),
      from: query.offset || 0,
      size: query.limit || 20,
      aggs: this.buildAggregations()
    }
    
    return await this.esClient.search({ index: 'aircraft', body })
  }
}
```

### 2.4 Analytics Service (–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)

#### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- –°–±–æ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –¶–µ–Ω–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤
- –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Runtime**: Python 3.11
- **Framework**: FastAPI + SQLAlchemy
- **Database**: ClickHouse (–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)
- **Cache**: Redis (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- **ML/Data**: Pandas, NumPy, Scikit-learn
- **Docker base**: python:3.11-alpine

#### Data Pipeline:
```python
# Data collection pipeline
class MarketDataCollector:
    def __init__(self):
        self.sources = [
            ControllerComScraper(),
            TradeAPlaneAPI(),
            AircraftBluebookAPI(),
            InternalTransactions()
        ]
    
    async def collect_daily_data(self):
        for source in self.sources:
            try:
                data = await source.fetch_data()
                await self.process_and_store(data)
            except Exception as e:
                logger.error(f"Failed to collect from {source}: {e}")

# Price analysis
class PriceAnalysisService:
    def calculate_market_value(self, aircraft: Aircraft) -> MarketValue:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º ML –º–æ–¥–µ–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        features = self.extract_features(aircraft)
        predicted_price = self.price_model.predict([features])[0]
        
        return MarketValue(
            estimated_price=predicted_price,
            confidence=self.calculate_confidence(features),
            comparable_aircraft=self.find_comparables(aircraft)
        )
```

#### ClickHouse Schema:
```sql
-- Market data events
CREATE TABLE market_events (
    event_time DateTime,
    event_type Enum('listing_created', 'listing_updated', 'transaction', 'price_change'),
    aircraft_id String,
    manufacturer String,
    model String,
    year UInt16,
    price Decimal(12, 2),
    currency String,
    location_country FixedString(2),
    source String,
    metadata String -- JSON
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_time)
ORDER BY (event_time, manufacturer, model);

-- Aggregated analytics
CREATE MATERIALIZED VIEW daily_price_analytics
ENGINE = AggregatingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (date, manufacturer, model)
AS SELECT
    toDate(event_time) as date,
    manufacturer,
    model,
    avgState(price) as avg_price,
    minState(price) as min_price,
    maxState(price) as max_price,
    countState() as listing_count
FROM market_events
WHERE event_type = 'listing_created'
GROUP BY date, manufacturer, model;
```

### 2.5 Payment Service (–ü–ª–∞—Ç–µ–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å)

#### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- –ö–æ–º–∏—Å—Å–∏–∏ —Å —Å–¥–µ–ª–æ–∫
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
- –£—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Runtime**: Go 1.21
- **Framework**: Gin + GORM
- **Database**: PostgreSQL (payments, subscriptions)
- **External**: Stripe, PayPal APIs
- **Docker base**: golang:1.21-alpine

#### Database Schema:
```sql
-- Subscriptions
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    plan_id VARCHAR(50) NOT NULL, -- basic, professional, enterprise
    status VARCHAR(20) NOT NULL, -- active, cancelled, expired
    current_period_start TIMESTAMP NOT NULL,
    current_period_end TIMESTAMP NOT NULL,
    auto_renew BOOLEAN DEFAULT TRUE,
    stripe_subscription_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Transactions
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'USD',
    type VARCHAR(20) NOT NULL, -- subscription, commission, refund
    status VARCHAR(20) NOT NULL, -- pending, completed, failed
    reference_id UUID, -- listing_id for commissions
    stripe_payment_intent_id VARCHAR(100),
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.6 Notification Service (–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

#### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è  
- Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:
- **Runtime**: Node.js + TypeScript
- **Framework**: Express.js
- **Queue**: RabbitMQ (async notifications)
- **Email**: SendGrid, AWS SES
- **SMS**: Twilio, AWS SNS
- **Docker base**: node:18-alpine

---

## 3. DOCKER –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### 3.1 Docker Compose –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  # Databases
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: atp_platform
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  clickhouse:
    image: clickhouse/clickhouse-server:23.11-alpine
    ports:
      - "8123:8123"
      - "9000:9000" 
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./scripts/clickhouse-init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  minio:
    image: minio/minio:RELEASE.2023-12-23T07-19-11Z
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Core Services
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/atp_platform
      REDIS_URL: redis://redis:6379
      JWT_SECRET: dev-secret-key
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/auth-service:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  verification-service:
    build:
      context: ./services/verification-service
      dockerfile: Dockerfile.dev
    ports:
      - "3002:3002"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/atp_platform
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672
      FAA_API_KEY: ${FAA_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./services/verification-service:/app

  marketplace-service:
    build:
      context: ./services/marketplace-service
      dockerfile: Dockerfile.dev
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/atp_platform
      ELASTICSEARCH_URL: http://elasticsearch:9200
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: admin
      MINIO_SECRET_KEY: admin123
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./services/marketplace-service:/app
      - /app/node_modules

  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile.dev
    ports:
      - "3004:3004"
    environment:
      CLICKHOUSE_URL: http://clickhouse:8123
      REDIS_URL: redis://redis:6379
    depends_on:
      clickhouse:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/analytics-service:/app

  # API Gateway
  api-gateway:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/nginx/nginx.dev.conf:/etc/nginx/nginx.conf
      - ./infrastructure/nginx/ssl:/etc/nginx/ssl
    depends_on:
      - auth-service
      - verification-service
      - marketplace-service
      - analytics-service

  # Frontend
  web-app:
    build:
      context: ./frontend/web-app
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: http://localhost/api
    volumes:
      - ./frontend/web-app:/app
      - /app/node_modules

volumes:
  postgres_data:
  redis_data:
  es_data:
  clickhouse_data:
  rabbitmq_data:
  minio_data:
```

### 3.2 Production Docker Configuration

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  auth-service:
    image: atp-platform/auth-service:${VERSION}
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    environment:
      NODE_ENV: production
      DATABASE_URL: ${AUTH_DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      JWT_SECRET: ${JWT_SECRET}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ... other services with similar configuration
```

### 3.3 Kubernetes Deployment

```yaml
# k8s/auth-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  labels:
    app: auth-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: atp-platform/auth-service:latest
        ports:
        - containerPort: 3001
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: auth-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: auth-secrets
              key: redis-url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3001
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3001
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
spec:
  selector:
    app: auth-service
  ports:
    - protocol: TCP
      port: 3001
      targetPort: 3001
  type: ClusterIP
```

---

## 4. –ë–ê–ó–ê –î–ê–ù–ù–´–•

### 4.1 Database per Service –ø—Ä–∏–Ω—Ü–∏–ø

–ö–∞–∂–¥—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç —Å–≤–æ—é –æ—Ç–¥–µ–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

```sql
-- Auth Service Database
CREATE DATABASE auth_service;

-- Verification Service Database  
CREATE DATABASE verification_service;

-- Marketplace Service Database
CREATE DATABASE marketplace_service;

-- Payment Service Database
CREATE DATABASE payment_service;

-- Notification Service Database
CREATE DATABASE notification_service;
```

### 4.2 Data Consistency Strategy

#### Event Sourcing + CQRS:
```typescript
// Domain events
interface DomainEvent {
  eventId: string;
  eventType: string;
  aggregateId: string;
  eventData: any;
  eventVersion: number;
  occurredOn: Date;
}

// Event store
class EventStore {
  async saveEvents(aggregateId: string, events: DomainEvent[]): Promise<void> {
    // Save events to event store
    await this.db.transaction(async (trx) => {
      for (const event of events) {
        await trx('events').insert({
          event_id: event.eventId,
          aggregate_id: event.aggregateId,
          event_type: event.eventType,
          event_data: JSON.stringify(event.eventData),
          event_version: event.eventVersion,
          occurred_on: event.occurredOn
        });
      }
    });
    
    // Publish events to message queue
    for (const event of events) {
      await this.messageQueue.publish('domain-events', event);
    }
  }
}
```

#### Saga Pattern –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```typescript
// User registration saga
class UserRegistrationSaga {
  async handle(command: RegisterUserCommand): Promise<void> {
    try {
      // Step 1: Create user in Auth service
      const user = await this.authService.createUser(command.userData);
      
      // Step 2: Start verification process
      const verification = await this.verificationService.startVerification(user.id);
      
      // Step 3: Create initial subscription
      await this.paymentService.createTrialSubscription(user.id);
      
      // Step 4: Send welcome email
      await this.notificationService.sendWelcomeEmail(user.id);
      
    } catch (error) {
      // Compensating actions
      await this.rollbackUserRegistration(command);
    }
  }
}
```

---

## 5. API –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–ò

### 5.1 OpenAPI Specifications

```yaml
# auth-service-api.yaml
openapi: 3.0.3
info:
  title: Auth Service API
  version: 1.0.0
  description: Authentication and authorization service

paths:
  /api/auth/register:
    post:
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - companyName
                - userType
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                companyName:
                  type: string
                  maxLength: 255
                userType:
                  type: string
                  enum: [buyer, seller, broker]
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
        '400':
          description: Invalid input
        '409':
          description: Email already exists

components:
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        companyName:
          type: string
        userType:
          type: string
          enum: [buyer, seller, broker, admin]
        verificationLevel:
          type: integer
          minimum: 0
          maximum: 3
        status:
          type: string
          enum: [pending, verified, suspended]
```

### 5.2 GraphQL Schema

```graphql
# marketplace-service schema
type Query {
  aircraftListings(
    filter: AircraftFilter
    sort: SortOptions
    pagination: PaginationInput
  ): AircraftListingConnection!
  
  aircraftListing(id: ID!): AircraftListing
  
  searchAircraft(query: String!, filters: AircraftFilter): [AircraftListing!]!
}

type Mutation {
  createAircraftListing(input: CreateAircraftListingInput!): AircraftListing!
  updateAircraftListing(id: ID!, input: UpdateAircraftListingInput!): AircraftListing!
  deleteAircraftListing(id: ID!): Boolean!
  
  reserveCustomer(buyerId: ID!, listingId: ID!): CustomerReservation!
}

type AircraftListing {
  id: ID!
  seller: User!
  aircraftModel: String!
  manufacturer: String!
  yearManufactured: Int
  tailNumber: String
  hoursTotal: Int
  price: Decimal!
  currency: String!
  location: Location!
  description: String
  status: ListingStatus!
  featured: Boolean!
  images: [AircraftImage!]!
  specifications: AircraftSpecifications
  createdAt: DateTime!
  updatedAt: DateTime!
}

input AircraftFilter {
  manufacturer: [String!]
  model: [String!]
  yearRange: IntRange
  priceRange: DecimalRange
  hoursRange: IntRange
  location: LocationFilter
  features: [String!]
}

enum ListingStatus {
  ACTIVE
  SOLD
  SUSPENDED
  EXPIRED
}
```

---

## 6. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### 6.1 Security Architecture

```mermaid
graph TB
    subgraph "Security Layers"
        WAF[Web Application Firewall]
        Gateway[API Gateway + Rate Limiting]
        Auth[Authentication Layer]
        AuthZ[Authorization Layer]
        Services[Microservices]
        Data[Data Encryption]
    end
    
    Internet --> WAF
    WAF --> Gateway
    Gateway --> Auth
    Auth --> AuthZ
    AuthZ --> Services
    Services --> Data
```

### 6.2 Authentication & Authorization

#### JWT Token Structure:
```typescript
interface JWTPayload {
  sub: string; // user ID
  email: string;
  roles: string[];
  permissions: string[];
  verificationLevel: number;
  iat: number; // issued at
  exp: number; // expires at
  jti: string; // JWT ID for revocation
}

// RBAC implementation
class RBACService {
  async hasPermission(userId: string, resource: string, action: string): Promise<boolean> {
    const userRoles = await this.getUserRoles(userId);
    const permissions = await this.getRolePermissions(userRoles);
    
    return permissions.some(p => 
      p.resource === resource && 
      p.action === action
    );
  }
}
```

#### API Gateway Security:
```nginx
# nginx.conf security configuration
server {
    listen 443 ssl http2;
    
    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    
    # Security Headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'";
    
    # Rate Limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req zone=api burst=20 nodelay;
    
    # Authentication endpoint
    location /api/auth {
        proxy_pass http://auth-service:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Protected endpoints
    location /api/ {
        # Authenticate with auth service
        auth_request /auth-verify;
        
        proxy_pass http://marketplace-service:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-User-ID $upstream_http_x_user_id;
        proxy_set_header X-User-Roles $upstream_http_x_user_roles;
    }
    
    location = /auth-verify {
        internal;
        proxy_pass http://auth-service:3001/api/auth/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Authorization $http_authorization;
    }
}
```

### 6.3 Data Protection

#### Encryption at Rest:
```sql
-- Database encryption
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Encrypted columns
ALTER TABLE users ADD COLUMN phone_encrypted BYTEA;

-- Insert with encryption
INSERT INTO users (email, phone_encrypted) 
VALUES ('user@example.com', pgp_sym_encrypt('555-1234', '${ENCRYPTION_KEY}'));

-- Query with decryption
SELECT email, pgp_sym_decrypt(phone_encrypted, '${ENCRYPTION_KEY}') as phone 
FROM users;
```

#### Secrets Management:
```yaml
# docker-compose.secrets.yml
version: '3.8'

services:
  auth-service:
    secrets:
      - jwt_secret
      - database_password
      - encryption_key
    environment:
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      DATABASE_PASSWORD_FILE: /run/secrets/database_password

secrets:
  jwt_secret:
    external: true
  database_password:
    external: true
  encryption_key:
    external: true
```

---

## 7. –ú–û–ù–ò–¢–û–†–ò–ù–ì

### 7.1 Monitoring Stack

```yaml
# monitoring/docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:v2.47.0
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'

  grafana:
    image: grafana/grafana:10.2.0
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards

  jaeger:
    image: jaegertracing/all-in-one:1.51
    ports:
      - "16686:16686"
      - "14250:14250"
    environment:
      COLLECTOR_OTLP_ENABLED: true

  elasticsearch-logging:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    volumes:
      - es_logs_data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch-logging:9200

volumes:
  prometheus_data:
  grafana_data:
  es_logs_data:
```

### 7.2 Application Metrics

```typescript
// Prometheus metrics in Node.js services
import prometheus from 'prom-client';

// HTTP request metrics
const httpRequestDuration = new prometheus.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status'],
  buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10]
});

const httpRequestsTotal = new prometheus.Counter({
  name: 'http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status']
});

// Business metrics
const userRegistrations = new prometheus.Counter({
  name: 'user_registrations_total',
  help: 'Total number of user registrations',
  labelNames: ['user_type']
});

const aircraftListings = new prometheus.Gauge({
  name: 'aircraft_listings_active',
  help: 'Number of active aircraft listings',
  labelNames: ['manufacturer']
});

// Middleware for metrics collection
export const metricsMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    const route = req.route?.path || req.path;
    
    httpRequestDuration
      .labels(req.method, route, res.statusCode.toString())
      .observe(duration);
      
    httpRequestsTotal
      .labels(req.method, route, res.statusCode.toString())
      .inc();
  });
  
  next();
};
```

### 7.3 Logging Strategy

```typescript
// Structured logging with Winston
import winston from 'winston';
import { ElasticsearchTransport } from 'winston-elasticsearch';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { 
    service: process.env.SERVICE_NAME,
    version: process.env.SERVICE_VERSION 
  },
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),
    new ElasticsearchTransport({
      level: 'info',
      clientOpts: { node: process.env.ELASTICSEARCH_URL },
      index: 'atp-platform-logs'
    })
  ]
});

// Usage in application
logger.info('User registered', {
  userId: user.id,
  userType: user.type,
  registrationSource: 'web'
});

logger.error('Database connection failed', {
  error: error.message,
  database: 'marketplace',
  operation: 'create_listing'
});
```

---

## 8. DEPLOYMENT

### 8.1 CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml
name: Deploy ATP Platform

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, verification-service, marketplace-service]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: services/${{ matrix.service }}/package-lock.json
    
    - name: Install dependencies
      run: |
        cd services/${{ matrix.service }}
        npm ci
    
    - name: Run tests
      run: |
        cd services/${{ matrix.service }}
        npm run test:coverage
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: services/${{ matrix.service }}/coverage/lcov.info

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'

  build-and-push:
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker images
      run: |
        services=("auth-service" "verification-service" "marketplace-service")
        for service in "${services[@]}"; do
          docker build -t ghcr.io/atp-platform/$service:${{ github.sha }} \
                       -t ghcr.io/atp-platform/$service:latest \
                       ./services/$service
          docker push ghcr.io/atp-platform/$service:${{ github.sha }}
          docker push ghcr.io/atp-platform/$service:latest
        done

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging
    
    steps:
    - name: Deploy to staging
      run: |
        # Deploy to Kubernetes staging namespace
        kubectl set image deployment/auth-service \
          auth-service=ghcr.io/atp-platform/auth-service:${{ github.sha }} \
          -n staging
        
        kubectl rollout status deployment/auth-service -n staging

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to production
      run: |
        # Blue-green deployment to production
        kubectl apply -f k8s/production/ -n production
        kubectl set image deployment/auth-service \
          auth-service=ghcr.io/atp-platform/auth-service:${{ github.sha }} \
          -n production
```

### 8.2 Infrastructure as Code

```terraform
# infrastructure/main.tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.20"
    }
  }
  
  backend "s3" {
    bucket = "atp-platform-terraform-state"
    key    = "infrastructure/terraform.tfstate"
    region = "us-east-1"
  }
}

# EKS Cluster
module "eks" {
  source  = "terraform-aws-modules/eks/aws"
  version = "19.15.3"

  cluster_name    = "atp-platform"
  cluster_version = "1.27"

  vpc_id     = module.vpc.vpc_id
  subnet_ids = module.vpc.private_subnets

  cluster_endpoint_public_access = true

  eks_managed_node_groups = {
    main = {
      desired_size = 3
      max_size     = 10
      min_size     = 3

      instance_types = ["t3.large"]
      capacity_type  = "ON_DEMAND"
    }
  }
}

# RDS PostgreSQL
resource "aws_db_instance" "main" {
  identifier = "atp-platform-db"
  
  engine         = "postgres"
  engine_version = "15.4"
  instance_class = "db.r6g.large"
  
  allocated_storage     = 100
  max_allocated_storage = 1000
  storage_encrypted     = true
  
  db_name  = "atp_platform"
  username = "postgres"
  password = var.db_password
  
  vpc_security_group_ids = [aws_security_group.rds.id]
  db_subnet_group_name   = aws_db_subnet_group.main.name
  
  backup_retention_period = 30
  backup_window          = "03:00-04:00"
  maintenance_window     = "sun:04:00-sun:05:00"
  
  deletion_protection = true
  skip_final_snapshot = false
  
  tags = {
    Name = "ATP Platform Database"
  }
}

# ElastiCache Redis
resource "aws_elasticache_subnet_group" "main" {
  name       = "atp-platform-cache-subnet"
  subnet_ids = module.vpc.private_subnets
}

resource "aws_elasticache_replication_group" "main" {
  replication_group_id       = "atp-platform-redis"
  description                = "Redis cluster for ATP Platform"
  
  node_type            = "cache.r6g.large"
  port                 = 6379
  parameter_group_name = "default.redis7"
  
  num_cache_clusters = 3
  
  subnet_group_name  = aws_elasticache_subnet_group.main.name
  security_group_ids = [aws_security_group.redis.id]
  
  at_rest_encryption_enabled = true
  transit_encryption_enabled = true
  auth_token                 = var.redis_auth_token
  
  automatic_failover_enabled = true
  multi_az_enabled          = true
  
  tags = {
    Name = "ATP Platform Redis"
  }
}
```

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–≠—Ç–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

1. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
2. **Docker-native –ø–æ–¥—Ö–æ–¥** –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** —á–µ—Ä–µ–∑ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –Ω–∞–≥—Ä—É–∑–∫–∏
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å** –¥–ª—è production-ready —Å–∏—Å—Ç–µ–º—ã
6. **CI/CD –ø—Ä–æ—Ü–µ—Å—Å—ã** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
7. **Infrastructure as Code** –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

–ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Å —É—á–µ—Ç–æ–º enterprise —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ –≥–æ—Ç–æ–≤ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ç—ã—Å—è—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. 